<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>記事一覧 - Business Style</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --main-color: #0d47a1;
      --accent-color: #1976d2;
      --bg-gradient: linear-gradient(135deg, #e3f2fd, #bbdefb);
      --card-bg: #fff;
      --text-color: #212121;
      --border-radius: 8px;
      --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-color);
      margin: 0 auto;
      padding: 20px;
      max-width: 1200px;
      line-height: 1.8;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      color: var(--main-color);
    }
    .card {
      position: relative;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 15px;
      margin: 0 auto 20px;
      max-width: 900px;
      height: 120px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border: 1px solid #e0e0e0;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }
    .card .title-date {
      position: relative;
      margin-bottom: 5px;
    }
    .card h2 {
      font-size: 1.2em;
      margin: 0;
      color: var(--main-color);
      line-height: 1.4;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      text-overflow: ellipsis;
      padding-right: 80px; /* ← ここで日付のスペース確保 */
    }
    .card .date {
      position: absolute;
      top: 0;
      right: 0;
      font-size: 0.75em;
      color: #777;
      white-space: nowrap;
    }
    .card .content-preview {
      font-size: 0.85em;
      color: #555;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .card .actions a {
      position: absolute;
      bottom: 10px;
      right: 15px;
      background: var(--main-color);
      color: #fff;
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 30px;
      font-size: 0.8em;
      transition: background 0.3s;
    }
    .card .actions a:hover {
      background: var(--accent-color);
    }
    nav {
      text-align: center;
      margin-top: 40px;
    }
    nav a {
      background: var(--main-color);
      color: #fff;
      text-decoration: none;
      padding: 12px 24px;
      margin: 0 10px;
      border-radius: 30px;
      font-weight: bold;
      display: inline-block;
      transition: background 0.3s;
    }
    nav a:hover {
      background: var(--accent-color);
    }
    #toggleMonthView {
      background: var(--main-color);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 30px;
      font-weight: bold;
      cursor: pointer;
      margin: 0 auto 20px;
      display: block;
      transition: background 0.3s;
    }
    #toggleMonthView:hover {
      background: var(--accent-color);
    }

    /* スマホ対応 */
    @media (max-width: 600px) {
      .card {
        height: auto;
        padding: 10px;
      }
      .card .title-date {
        display: block;
        position: relative;
      }
      .card h2 {
        font-size: 1em;
        padding-right: 80px;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        text-overflow: ellipsis;
        line-height: 1.4;
      }
      .card .date {
        position: absolute;
        top: 0;
        right: 10px;
        font-size: 0.65em;
        color: #777;
        white-space: nowrap;
      }
      .card .content-preview {
        font-size: 0.75em;
        margin-top: 6px;
      }
      .card .actions a {
        font-size: 0.7em;
        padding: 5px 10px;
      }
    }
  </style>
</head>

<body>

<h1>記事一覧</h1>

<button id="toggleMonthView">📅 月別で見る</button>

<div id="articlesList"></div>

<nav>
  <a href="editor.html">✏️ 新しく書く</a>
  <a href="drafts.html">📄 下書き一覧</a>
</nav>

<script>
// fitTitleInTwoLines関数はそのままOK
function fitTitleInTwoLines(titleText) {
  const temp = document.createElement('h2');
  temp.style.cssText = 'visibility:hidden;position:absolute;width:calc(100% - 80px);font-size:' +
    (window.innerWidth <= 600 ? '1em' : '1.2em') + ';line-height:1.4;';
  temp.textContent = titleText;
  document.body.appendChild(temp);

  const oneLineHeight = temp.offsetHeight;
  const maxAllowedHeight = oneLineHeight * 2;
  let fitted = titleText;

  while (temp.offsetHeight > maxAllowedHeight && fitted.length > 0) {
    fitted = fitted.slice(0, -1);
    temp.textContent = fitted + '…';
  }

  document.body.removeChild(temp);
  return fitted.length < titleText.length ? fitted + '…' : fitted;
}

const articlesList = document.getElementById("articlesList");
const toggleMonthView = document.getElementById("toggleMonthView");
const articles = JSON.parse(localStorage.getItem('articles') || '{}');
let monthView = false;

toggleMonthView.addEventListener("click", () => {
  monthView = !monthView;
  renderArticles();
  toggleMonthView.textContent = monthView ? "📝 全部の記事を見る" : "📅 月別で見る";
});

function formatDate(dateStr) {
  if (!dateStr) return "";
  const date = new Date(dateStr);
  return isNaN(date) ? dateStr.replace(/\//g, ".") : date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
}

function createCard(article) {
  const card = document.createElement("div");
  card.className = "card";
  const preview = (article.content || article.summary || "本文なし").replace(/\s+/g, '').slice(0, 14) + "…";

  card.innerHTML = `
    <div class="title-date">
      <h2>${fitTitleInTwoLines(article.title)}</h2>
      <div class="date">${formatDate(article.publishedAt || article.datePublished || article.date)}</div>
    </div>
    <div class="content-preview">${preview}</div>
    <div class="actions">
      <a href="article.html?id=${article.id}">続きを読む</a>
    </div>
  `;
  return card;
}

function renderArticles() {
  articlesList.innerHTML = "";

  const published = Object.entries(articles)
    .filter(([_, article]) => article.status === "published" || article.status === "public")
    .sort((a, b) => new Date(b[1].publishedAt || b[1].datePublished || b[1].date) - new Date(a[1].publishedAt || a[1].datePublished || a[1].date));

  if (published.length === 0) {
    articlesList.innerHTML = "<p style='text-align:center;'>まだ公開された記事はありません。</p>";
    return;
  }

  if (monthView) {
    const grouped = {};
    published.forEach(([id, article]) => {
      const baseDate = article.publishedAt || article.datePublished || article.date;
      const month = baseDate ? baseDate.slice(0, 7).replace("/", "-") : "不明";
      if (!grouped[month]) grouped[month] = [];
      grouped[month].push({ id, ...article });
    });

    Object.keys(grouped).sort((a, b) => b.localeCompare(a)).forEach(month => {
      const monthSection = document.createElement("section");
      monthSection.style.marginTop = "40px";

      const monthTitle = document.createElement("h2");
      monthTitle.textContent = month.replace("-", "年") + "月の記事 ▶";
      monthTitle.style.cssText = "color:var(--main-color);font-size:1.4em;border-bottom:2px solid var(--accent-color);padding-bottom:5px;margin-bottom:10px;cursor:pointer;";

      const articleContainer = document.createElement("div");
      articleContainer.style.cssText = "overflow:hidden;max-height:0;transition:max-height 0.4s ease;margin-top:10px;";

      monthTitle.addEventListener("click", () => {
        const open = articleContainer.style.maxHeight !== "0px" && articleContainer.style.maxHeight !== "0";
        articleContainer.style.maxHeight = open ? "0" : articleContainer.scrollHeight + "px";
        monthTitle.textContent = month.replace("-", "年") + "月の記事 " + (open ? "▶" : "▼");
      });

      grouped[month].forEach(article => articleContainer.appendChild(createCard(article)));
      monthSection.append(monthTitle, articleContainer);
      articlesList.appendChild(monthSection);
    });

  } else {
    published.forEach(([id, article]) => articlesList.appendChild(createCard(article)));
  }
}

renderArticles();
</script>

</body>
</html>
